<div class="main main-hub p-3">
  <h3 class="mb-4 clearfix heading">
    Announcements
  </h3>
  <div class="mt-2">
    <div class="main-tab-nav">
      <mat-tab-group>
        <mat-tab label="Announcements">
          <div class="communication">
            <div class="buttons-row row mt-3 justify-content-between mx-2">
              <button type="button" class="btn btn-primary" (click)="openModal(anncModal, false)">
                New Announcement
              </button>
            </div>
            <div class="row mt-4 mx-0">
              <div class="sub-tab-nav"
                [ngClass]="{'col-md-12': !showRowInfo, 'col-sm-0 col-md-6 col-lg-7 col-xl-8': showRowInfo}">
                <div class="card overflow-hidden">
                  <div class="card-header border-0">
                    <mat-tab-group [selectedIndex]="activeIndex" (selectedTabChange)="onTabChange($event)">
                      <mat-tab label="Sent">
                        <app-loader [type]="'page'" *ngIf="loading"></app-loader>
                        <ng-container *ngTemplateOutlet="ancmntTable"></ng-container>
                      </mat-tab>
                      <mat-tab label="Scheduled">
                        <app-loader [type]="'page'" *ngIf="loading"></app-loader>
                        <ng-container *ngTemplateOutlet="ancmntTable"></ng-container>
                      </mat-tab>
                      <mat-tab label="Archived">
                        <app-loader [type]="'page'" *ngIf="loading"></app-loader>
                        <ng-container *ngTemplateOutlet="ancmntTable"></ng-container>
                      </mat-tab>
                    </mat-tab-group>
                  </div>
                </div>
              </div>
              <div class="workspace w-100 col-12 col-md-6 col-lg-5 col-xl-4" *ngIf="showRowInfo">
                <app-loader [type]="'page'" *ngIf="docLoading"></app-loader>
                <div class="doc" *ngIf="!docLoading">
                  <div class="card">
                    <div class="card-header row m-0">
                      <h5 class="mb-0 pl-0 align-self-center">Announcement details</h5>
                      <div class="ml-auto">
                        <div class="btn btn-light" (click)="closeDoc()">
                          <i class="fa fa-times"></i>
                        </div>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="doc-details details border-bottom mb-3 pb-3">
                        <div class="subject">
                          <label class="text-hi-dark-grey mb-0 mt-2">Subject</label>
                          <div class="value">{{rowInfo.subject||'N/A'}}</div>
                        </div>
                        <div class="created">
                          <label class="text-hi-dark-grey mb-0 mt-2">Created</label>
                          <div class="value">{{(rowInfo.createdDate|date:'dd MMM, yyyy')||'N/A'}}</div>
                        </div>
                        <div class="author">
                          <label class="text-hi-dark-grey mb-0 mt-2">Author</label>
                          <div class="value">{{rowInfo.createdByFullName||'N/A'}}</div>
                        </div>
                        <div class="recipients">
                          <label class="text-hi-dark-grey mb-0 mt-2">Recipients</label>
                          <div class="value">
                            <span *ngIf="rowInfo.sendToGroup===1">All Users</span>
                            <span *ngIf="rowInfo.sendToGroup!=1 && rowInfo.recipients && rowInfo.recipients.length>0">
                              <span *ngFor="let rcp of rowInfo.recipients"
                                class="badge badge-light p-2 mt-2 mt-sm-0">{{rcp.name}}</span>
                            </span>
                          </div>
                        </div>
                        <div class="requestUpdate">
                          <label class="text-hi-dark-grey mb-0 mt-2">Request Update</label>
                          <div class="value">{{rowInfo.requestToUpdate?'Yes':'No'}}</div>
                        </div>
                        <div class="sendEmailReminders">
                          <label class="text-hi-dark-grey mb-0 mt-2">Send email reminders</label>
                          <div class="value">{{rowInfo.notifyByEmail?'Yes':'No'}}</div>
                        </div>
                        <div *ngIf="activeIndex==0||activeIndex==2 else schAncmnt">
                          <div class="status">
                            <label class="text-hi-dark-grey mb-0 mt-2">Status</label>
                            <div class="value">Sent</div>
                          </div>
                          <div class="status">
                            <label class="text-hi-dark-grey mb-0 mt-2">Date Sent</label>
                            <div class="value">{{(rowInfo.deliveredOn|date:'dd MMM, yyyy h:mm a')||'N/A'}}</div>
                          </div>
                        </div>
                        <ng-template #schAncmnt>
                          <div class="status">
                            <label class="text-hi-dark-grey mb-0 mt-2">Status</label>
                            <div class="value">Scheduled</div>
                          </div>
                          <div class="status">
                            <label class="text-hi-dark-grey mb-0 mt-2">Scheduled</label>
                            <div class="value">{{(rowInfo.scheduledOn|date:'dd MMM, yyyy h:mm a')||'N/A'}}</div>
                          </div>
                        </ng-template>
                        <div class="readRate">
                          <label class="text-hi-dark-grey mb-0 mt-2">Read Rate</label>
                          <div class="value">
                            {{rowInfo.viewPercentage?rowInfo.viewPercentage:0}}%
                          </div>
                        </div>
                      </div>
                      <div class="announcement details border-bottom mb-3 pb-3">
                        <div class="announcement">
                          <div class="value">{{rowInfo.body||'N/A'}}</div>
                        </div>
                      </div>
                      <div class="additions details border-bottom mb-3 pb-3">
                        <div class="heading text-hi-dark-grey font-weight-bold">Additions</div>
                        <div class="partNoDesc">
                          <label class="text-hi-dark-grey mb-0 mt-2">Part No. Sescription</label>
                          <div class="value">
                            <ul class="list-unstyled mb-0">
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                      <div class="amendmentsToThePrice details border-bottom mb-3 pb-3">
                        <div class="heading text-hi-dark-grey font-weight-bold">Amendments To The Price</div>
                        <div class="partNoDesc">
                          <label class="text-hi-dark-grey mb-0 mt-2">Part No. Sescription</label>
                          <div class="value">
                            <ul class="list-unstyled mb-0">
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                      <div class="amendmentsToTheDesc details border-bottom mb-3 pb-3">
                        <div class="heading text-hi-dark-grey font-weight-bold">Amendments To The Description</div>
                        <div class="partNoDesc">
                          <label class="text-hi-dark-grey mb-0 mt-2">Part No. Sescription</label>
                          <div class="value">
                            <ul class="list-unstyled mb-0">
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                      <div class="itemsRemoved details">
                        <div class="heading text-hi-dark-grey font-weight-bold">Items Removed form the Price Lists</div>
                        <div class="partNoDesc">
                          <label class="text-hi-dark-grey mb-0 mt-2">Part No. Sescription</label>
                          <div class="value">
                            <ul class="list-unstyled mb-0">
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                              <li>IW25B-64A Cover</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>
</div>

<ng-template #ancmntTable>
  <div *ngIf="!loading">
    <div class="card-body bg-white rounded-bottom px-0 pb-0">
      <div class="card-text px-3 min-height">
        <table class="table table-hover text-dark w-100" [ngClass]="{'hide-rows': showRowInfo}">
          <thead>
            <tr>
              <th class="curs-ptr" *ngFor="let col of cols;let i =index" (click)="sortChange(col,i)">
                {{col.n}}
                <i class="ml-1 fas"
                  [ngClass]="{'fa-sort-down align-top': !col.asc, 'fa-sort-up align-bottom': col.asc}"></i>
              </th>
              <th *ngIf="activeIndex==0 || activeIndex==1"></th>
            </tr>
          </thead>
          <tbody *ngIf="!loading && ancmnts.length > 0">
            <tr *ngFor="let ancmnt of ancmnts" (click)="toggleInfo(ancmnt)"
              [ngClass]="{'sel-row':(rowInfo.id === ancmnt.id)}">
              <td *ngFor="let col of cols">
                <span [ngSwitch]="col.k">
                  <span *ngSwitchCase="'sendToGroup'">
                    <span *ngIf="ancmnt.sendToGroup===1">All Users</span>
                    <span *ngIf="ancmnt.sendToGroup!=1 && ancmnt.recipients && ancmnt.recipients.length>0">
                      <span *ngFor="let rcp of ancmnt.recipients"
                        class="badge badge-light p-2 mt-2 mt-sm-0 mr-2">{{rcp.name}}</span>
                    </span>
                  </span>
                  <span *ngSwitchCase="'deliveredOn'">
                    {{(ancmnt[col.k]|date:'dd MMM, yyyy')||'N/A'}}
                  </span>
                  <span *ngSwitchCase="'scheduledOn'">
                    {{(ancmnt[col.k]|date:'dd MMM, yyyy')||'N/A'}}
                  </span>
                  <span *ngSwitchCase="'viewPercentage'">
                    {{ancmnt.viewPercentage?ancmnt.viewPercentage:0}}%
                  </span>
                  <span *ngSwitchDefault>{{ancmnt[col.k]||'N/A'}}</span>
                </span>
              </td>
              <td *ngIf="activeIndex==0 || activeIndex==1">
                <button *ngIf="activeIndex==0" class="btn btn-primary btn-sm hover-btn"
                  (click)="archAncmnt($event, ancmnt)">Archive</button>
                <button *ngIf="activeIndex==1" class="btn btn-primary btn-sm hover-btn"
                  (click)="updAncmnt($event, ancmnt, anncModal)">Edit</button>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="text-center text-secondary" *ngIf="!loading && ancmnts.length == 0">
          No Announcement found
        </div>
      </div>
      <app-pagination [pageSize]="pageSize" [totalCount]="totalCount" [page]="pageNo"
        (pageSizeChange)="pageSizeChange($event)" (paginationNum)="paginationNum($event)"></app-pagination>
    </div>
  </div>
</ng-template>

<!-- new announcment Modal -->
<ng-template #anncModal let-modal class="custom-modal">
  <div class="modal-header">
    <h4 class="modal-title">{{isEdit?'Edit':'New'}} Announcement</h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <form name="ancmntForm" (ngSubmit)="onSubmit()" [formGroup]="ancmntForm" novalidate>
    <div class="modal-body" ngbAutofocus>
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Subject</mat-label>
        <input matInput placeholder="Subject" formControlName="subject" maxlength="100" required />
        <mat-error *ngIf="ancmntForm.get('subject')!.hasError('required')">
          Subject is required
        </mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline" class="w-100 quill-editor-container" [floatLabel]="'always'">
        <mat-label>Announcement</mat-label>
        <input class="d-none" matInput />
        <quill-editor class="quill-edt" placeholder="Body" formControlName="body" [modules]="quillConfig">
        </quill-editor>
      </mat-form-field>
      <mat-error class="ml-0-9 mb-0"
        *ngIf="(ancmntForm.get('body')!.touched ||ancmntForm.get('body')!.dirty) && ancmntForm.get('body')!.hasError('required')">
        Announcement is required
      </mat-error>
      <mat-form-field appearance="outline"
        [ngClass]="{'mt-1-2': !((ancmntForm.get('body')!.touched ||ancmntForm.get('body')!.dirty) && ancmntForm.get('body')!.hasError('required'))}">
        <mat-label>Send To</mat-label>
        <mat-select formControlName="sendToGroup" (selectionChange)="changeGrp($event)" required>
          <mat-option *ngFor="let gT of grpType" [value]="gT.v">{{gT.n}}</mat-option>
        </mat-select>
        <mat-error *ngIf="ancmntForm.get('sendToGroup')!.hasError('required')">
          Send To is required
        </mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline" class="w-100"
        *ngIf="ancmntForm.controls.usrWrkSpcs && ancmntForm.value.sendToGroup==2">
        <mat-chip-list #chipList aria-label="Select Workspaces">
          <mat-chip *ngFor="let d of selWrkSpcs" [selectable]="selectable" [removable]="removable"
            (removed)="remove(d, 'selWrkSpcs')">
            {{d.name}}
            <i matChipRemove class="fas fa-times-circle" *ngIf="removable"></i>
          </mat-chip>
          <input matInput #wrkSpcInp formControlName="usrWrkSpcs" placeholder="Select user workspaces(s)"
            [matAutocomplete]="auto1">
        </mat-chip-list>
        <mat-autocomplete #auto1="matAutocomplete"
          (optionSelected)="selFromAutoComp($event.option.value,'selWrkSpcs',wrkSpcInp)" [displayWith]="displayFn">
          <mat-option *ngFor="let wrkSpc of wrkSpcs" [value]="wrkSpc">
            {{wrkSpc.name}} <br />
            <small *ngIf="wrkSpc.hub && wrkSpc.hub.name">{{wrkSpc.hub.name}}</small>
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      <mat-form-field appearance="outline" class="w-100"
        *ngIf="ancmntForm.controls.usrGrps && ancmntForm.value.sendToGroup==3">
        <mat-chip-list #chipList1 aria-label="Select user Group(s)">
          <mat-chip *ngFor="let d of selGrps" [selectable]="selectable" [removable]="removable"
            (removed)="remove(d,'selGrps')">
            {{d.name}}
            <i matChipRemove class="fas fa-times-circle" *ngIf="removable"></i>
          </mat-chip>
          <input matInput #grpInp formControlName="usrGrps" placeholder="Select user group(s)"
            [matAutocomplete]="auto2">
        </mat-chip-list>
        <mat-autocomplete #auto2="matAutocomplete"
          (optionSelected)="selFromAutoComp($event.option.value,'selGrps',grpInp)" [displayWith]="displayFn">
          <mat-option *ngFor="let grp of grps" [value]="grp">
            {{grp.name}}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      <mat-checkbox formControlName="requestToUpdate" class="d-block ml-3">Request user to update content</mat-checkbox>
      <mat-checkbox formControlName="notifyByEmail" class="d-block ml-3">Notify User by Email</mat-checkbox>
      <mat-checkbox formControlName="sendLater" class="d-block ml-3" (change)="enbDisbDateTime($event)">Send Later
      </mat-checkbox>
      <div class="row justify-content-between m-0">
        <mat-form-field appearance="outline">
          <mat-label>Choose a date</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="date" [min]="minDate">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="ancmntForm.get('date')!.hasError('required')">
            Date is required
          </mat-error>
          <mat-error *ngIf="ancmntForm.get('date')!.hasError('matDatepickerMin')">
            Date should be equal to or greater than today's date
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Time</mat-label>
          <mat-select formControlName="time">
            <mat-option [value]="">Select Time</mat-option>
            <mat-option *ngFor="let t of time" [value]="t">{{t}}</mat-option>
          </mat-select>
          <mat-error *ngIf="ancmntForm.get('time')!.hasError('required')">
            Time is required
          </mat-error>
        </mat-form-field>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" [disabled]="disabled"
        (click)="modal.dismiss('Cross click')">Close</button>
      <button class="btn btn-primary" [disabled]="ancmntForm!.invalid || (ancmntForm.value.sendToGroup==2 && selWrkSpcs.length<=0)
        || (ancmntForm.value.sendToGroup==3 && selGrps.length<=0) || disabled">
        <app-loader [type]="'btn'" *ngIf="disabled"></app-loader>
        {{ancmntForm.value.sendLater?'Schedule':'Send'}}
      </button>
    </div>
  </form>
</ng-template>
