<app-loader [type]="'page'" *ngIf="catgLoading && tagLoading; else loadPage;"></app-loader>
<ng-template #loadPage>
  <div class="tags-page row mx-0">
    <div class="sub-tab-nav row mx-0 mt-4 px-0" [ngClass]="{'col-md-12': !showRowInfo, 'col-md-8': showRowInfo}">
      <div class="col" style="min-width: 265px; max-width: 265px;">
        <div class="card bg-hi-grey" style="min-height:100% !important;">
          <div class="card-body">
            <div class="text-hi-dark-grey">Tags</div>
            <ul class="list-unstyled pl-2 mt-1">
              <li class="dark-bg-hover px-2 py-1 rounded mt-2" [ngClass]="{'act-tag': selTag == 'all'}"
                (click)="chngTags('all')">All tags</li>
              <li class="dark-bg-hover px-2 py-1 rounded mt-2" [ngClass]="{'act-tag': selTag == 'uncatg'}"
                (click)="chngTags('uncatg')">
                Uncategorized Tags
              </li>
            </ul>
            <hr>
            <div class="text-hi-dark-grey">
              Categories
              <div class="float-right btn p-0" (click)="showCatgIn = !showCatgIn"><i
                  class="fa fa-plus-circle text-primary"></i>
              </div>
              <form name="catgForm" (ngSubmit)="addCatg()" [formGroup]="catgForm" novalidate *ngIf="showCatgIn">
                <mat-form-field appearance="outline" class="custom-mat-input sp-mat-input w-100 my-2 flex bg-white"
                  [floatLabel]="'never'">
                  <input matInput placeholder="Add Category" class="ml-0" formControlName="name" required>
                  <div matSuffix>
                    <button class="btn btn-secondary input-btn mr-1" (click)="cancelCatg();">
                      <i class="fas fa-times"></i>
                    </button>
                    <button type="submit" class="btn btn-primary input-btn"
                      [disabled]="catgForm!.invalid || catgAddDisabled">
                      <app-loader [type]="'btn'" *ngIf="catgAddDisabled" class="align-spin-top"></app-loader>
                      <i class="fas fa-check-circle" *ngIf="!catgAddDisabled"></i>
                    </button>
                  </div>
                  <mat-error *ngIf="catgForm.get('name')!.hasError('required')" class="mt-3">
                    Name is required
                  </mat-error>
                </mat-form-field>
              </form>
            </div>
            <ul ngbNav #catgNav="ngbNav" [(activeId)]="activeCatgs"
              class="nav-tabs justify-content-end border-bottom-0 mr-0 border-color-grey w-100"
              (activeIdChange)="changeDispCatgs()">
              <li [ngbNavItem]="1">
                <a ngbNavLink>Active</a>
              </li>
              <li [ngbNavItem]="2">
                <a ngbNavLink>Disabled</a>
              </li>
            </ul>
            <ul class="list-unstyled cat-list pl-2 border-top">
              <app-loader [type]="'div'" *ngIf="catgLoading; else loadCatgs;"></app-loader>
              <ng-template #loadCatgs>
                <ng-container *ngIf="catgs.length > 0; else noCatg">
                  <li class="dark-bg-hover px-2 py-1 rounded mt-2" *ngFor="let catg of catgs"
                    (click)="chngTags(catg.id)" [ngClass]="{'act-tag': selTag == catg.id}">
                    {{catg.name}}
                    <div class="float-right row mx-0">
                      <div class="dropdown">
                        <div class="dropdown-toggle disable-icon" type="button" id="catEllipsis" data-toggle="dropdown"
                          aria-haspopup="true" aria-expanded="false">
                          <i class="fa fa-ellipsis-h"></i>
                        </div>
                        <div class="dropdown-menu" aria-labelledby="catEllipsis">
                          <a class="dropdown-item" (click)="updCatgModal(editCategory, catg)">
                            <i class="fas fa-edit mr-1"></i>Edit
                          </a>
                          <a class="dropdown-item text-{{catg.isActive ? 'primary' : 'success'}}"
                            (click)="actDeactCatg(catg)">
                            <i class="mr-1 fas"
                              [ngClass]="{'fa-toggle-off': catg.isActive, 'fa-toggle-on': !catg.isActive}"></i>
                            {{catg.isActive ? 'Deactivate' : 'Activate'}}
                          </a>
                        </div>
                      </div>
                    </div>
                  </li>
                </ng-container>
                <ng-template #noCatg>
                  <div class="text-secondary text-center mt-2">
                    No catgories found
                  </div>
                </ng-template>
              </ng-template>
            </ul>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card overflow-hidden w-100">
          <div class="card-body rounded-bottom px-0 pb-0">
            <h5 class="card-title px-3">
              <div class="heading">
                <mat-form-field appearance="outline" class="custom-mat-input float-right mb-3" [floatLabel]="'never'"
                  style="min-width: 300px;">
                  <i matPrefix class="fa fa-search text-secondary"></i>
                  <input matInput placeholder="Search Tag ..." class="ml-0" #sear [(ngModel)]="searchTxt">
                </mat-form-field>
                <div class="search mb-2" *ngIf="tagForm">
                  <form name="tagForm" (ngSubmit)="addTags()" [formGroup]="tagForm" novalidate class="row w-100 mx-0">
                    <mat-form-field class="custom-mat-input mr-3" appearance="outline" [floatLabel]="'never'"
                      style="flex:1;">
                      <mat-chip-list #tagList aria-label="tag selection" formControlName="name">
                        <mat-chip *ngFor="let tag of tagNames" selectable removable (removed)="removeChip(tag)">
                          {{tag}}
                          <i class="fa fa-times" matChipRemove></i>
                        </mat-chip>
                        <input placeholder="Add Tags (Separate tags by comma or enter)" [matChipInputFor]="tagList"
                          [matChipInputSeparatorKeyCodes]="separatorKeysCodes" matChipInputAddOnBlur
                          (matChipInputTokenEnd)="addChips($event)" formControlName="name">
                      </mat-chip-list>
                    </mat-form-field>
                    <button type="submit" class="btn btn-primary ml-auto" [disabled]="tagForm!.invalid || tagAddDisabled">
                      <app-loader [type]="'btn'" *ngIf="tagAddDisabled"></app-loader>
                      Create
                    </button>
                  </form>
                </div>
              </div>
            </h5>
            <ul ngbNav #TagsNav="ngbNav" [(activeId)]="activeTags"
              class="nav-tabs justify-content-end border-bottom-0 mr-3" (activeIdChange)="chngDispTags()">
              <li [ngbNavItem]="1">
                <a ngbNavLink>Active</a>
              </li>
              <li [ngbNavItem]="2">
                <a ngbNavLink>Disabled</a>
              </li>
            </ul>
            <app-loader [type]="'page'" *ngIf="tagLoading"></app-loader>
            <div *ngIf="!tagLoading">
              <div class="card-text px-3">
                <table class="table table-hover text-dark w-100" [ngClass]="{'hide-rows': showRowInfo}">
                  <thead>
                    <tr>
                      <th class="curs-ptr" *ngFor="let col of cols;let i =index" (click)="sortChange(col,i)">
                        {{col.n}}
                        <i *ngIf="col.k!='isActive'" class="fas ml-1" [ngClass]="{'fa-sort-down align-top': !col.asc, 'fa-sort-up align-bottom': col.asc}"></i>
                      </th>
                    </tr>
                  </thead>
                  <tbody *ngIf="!tagLoading && tags.length > 0">
                    <tr class="curs-ptr" (click)="toggleInfo(tag)" *ngFor="let tag of tags" [ngClass]="{'sel-row':(rowInfo.id === tag.id)}">
                      <td>{{tag.name}}</td>
                      <td class="text-hi-dark-grey">{{tag.isActive?'Active':'In Active'}}</td>
                      <td>{{(tag.updatedDate|date:'dd MMM, yyyy HH:mm')||'N/A'}}</td>
                    </tr>
                  </tbody>
                </table>
                <div class="text-center text-secondary" style="min-height: 230px; padding-top:95px;"
                  *ngIf="tags.length == 0">
                  No data found
                </div>
              </div>
              <app-pagination [pageSize]="pageSize" [totalCount]="totalCount" [page]="pageNo"
                (pageSizeChange)="pageSizeChange($event)" (paginationNum)="changePageNo($event)"></app-pagination>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="workspace w-100 col-md-4 mt-4" *ngIf="showRowInfo">
      <div class="document">
        <div class="card">
          <div class="card-header row m-0">
            <h5 class="mb-0 pt-1 col-10 pl-0 align-self-center">{{rowInfo.name}}</h5>
            <div class="mr-2 col-1 ml-auto">
              <div class="btn btn-light" (click)="closeDoc()">
                <i class="fas fa-times"></i>
              </div>
            </div>
          </div>
          <div class="card-header bg-hi-light-grey d-flex">
            <div class="btn btn-sm btn-outline-{{rowInfo.isActive ? 'primary' : 'success'}}" (click)=" actDeactTag()">
              {{rowInfo.isActive ? 'Deactivate' : 'Activate'}}
              <i class="fas" [ngClass]="{'fa-toggle-off': rowInfo.isActive, 'fa-toggle-on': !rowInfo.isActive}"></i>
            </div>
            <div class="btn btn-sm btn-light ml-auto" (click)="updTagModal(editTag)">
              <i class="fas fa-edit"></i>
            </div>
          </div>
          <div class="card-body">
            <div class="doc-details details border-bottom mb-3 pb-3">
              <div class="heading text-hi-dark-grey font-weight-bold">Details</div>
              <div class="name">
                <label class="text-hi-dark-grey mb-0 mt-2">Name</label>
                <div class="value">
                  {{rowInfo.name}}
                </div>
              </div>
              <div class="orgCategories">
                <label class="text-hi-dark-grey mb-0 mt-2">Organized in Categories</label>
                <div class="value">
                  <ng-container *ngIf="rowInfo.categories.length>0; else noCatg">
                    <ul class="mb-0">
                      <li *ngFor="let cn of rowInfo.categories">{{cn.name}}</li>
                    </ul>
                  </ng-container>
                  <ng-template #noCatg>
                    No Categories
                  </ng-template>
                </div>
              </div>
              <div class="orgCategories">
                <label class="text-hi-dark-grey mb-0 mt-2">Assigned In</label>
                <div class="value">
                  No data
                </div>
              </div>
              <div class="usedIn">
                <label class="text-hi-dark-grey mb-0 mt-2">Used In</label>
                <div class="value">
                  No data
                </div>
              </div>
            </div>
            <div class="doc-details status">
              <div class="heading text-hi-dark-grey font-weight-bold">Status</div>
              <div class="created">
                <label class="text-hi-dark-grey mb-0 mt-2">Date Created</label>
                <div class="value">
                  {{rowInfo.createdDate.split('T')[0]}}
                </div>
              </div>
              <div class="updated">
                <label class="text-hi-dark-grey mb-0 mt-2">Date Updated</label>
                <div class="value">
                  {{rowInfo.updatedDate.split('T')[0]}}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- edit category modal  -->
<ng-template #editCategory let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Edit Category</h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <form name="updCatgForm" (ngSubmit)="updCatg()" [formGroup]="updCatgForm" novalidate>
    <div class="modal-body" ngbAutofocus>
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Name</mat-label>
        <input matInput type="text" placeholder="Name" formControlName="name" required>
        <mat-error *ngIf="updCatgForm.get('name')!.hasError('required')">
          Name is required
        </mat-error>
      </mat-form-field>
      <mat-label>Published</mat-label>
      <mat-checkbox class="d-block">Published</mat-checkbox>
      <p class="text-danger">
        When published, a tag category becomes available to users for filtering content based on tags (e.g. in
        advanced search). You can uncheck this option to prevent a tag category can be used for filtering. Tags that
        are part of an unpublished category will never be shown to users.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary mr-2" (click)="modal.dismiss('Cross click')">Cancel</button>
      <button type="submit" class="btn btn-primary" [disabled]="updCatgForm!.invalid || updDisabled">
        <app-loader [type]="'btn'" *ngIf="updDisabled"></app-loader>
        Update
      </button>
    </div>
  </form>
</ng-template>

<!-- edit tag modal  -->
<ng-template #editTag let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Edit Tag</h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <form name="tagForm" (ngSubmit)="updTag()" [formGroup]="tagForm" novalidate>
    <div class="modal-body" ngbAutofocus>
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Name</mat-label>
        <input matInput type="text" placeholder="Name" formControlName="name" required>
        <mat-error *ngIf="tagForm.get('name')!.hasError('required')">
          Name is required
        </mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Organized in Categories</mat-label>
        <mat-select multiple [(value)]="rowInfo.categoryIDs">
          <mat-option hidden></mat-option>
          <mat-option *ngFor="let catg of catgs" value="{{catg.id}}">{{catg.name}}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary mr-2" (click)="modal.dismiss('Cross click')">Cancel</button>
      <button type="submit" class="btn btn-primary" [disabled]="tagForm!.invalid || updDisabled">
        <app-loader [type]="'btn'" *ngIf="updDisabled"></app-loader>
        Update
      </button>
    </div>
  </form>
</ng-template>
